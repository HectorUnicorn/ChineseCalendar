\documentclass[12pt]{article}
\usepackage[margin=0.8in,top=0.8in,bottom=0.8in]{geometry}
\usepackage{graphicx}
\usepackage{hyperref}
\usepackage{CJK}
%\usepackage{pinyin}
\newcommand \beq {\begin{equation}}
\newcommand \eeq {\end{equation}}
\newcommand \beqn {\begin{eqnarray}}
\newcommand \eeqn {\end{eqnarray}}
\newcommand{\ve}[1]{\mbox{\boldmath $#1$}}
%\newcommand{\expl}{\href{http://www.uscibooks.com/urban.htm}{\it Explanatory Supplement to the Astronomical Almanac}}
\newcommand{\expl}{\cite{expl}}
%\newcommand{\kaplan}{\href{http://aa.usno.navy.mil/publications/docs/Circular_179.pdf}{\it The IAU Resolutions on Astronomical Reference Systems, Time Scales, and Earth Rotation Models, Circular 179}}
\newcommand{\kaplan}{\cite{kaplan05}}
%\newcommand{\iers}{\href{http://iers-conventions.obspm.fr/2010/2010_official/tn36.pdf}{IERS Conventions 2010}}
\newcommand{\iers}{\cite{iers2010}}
\newcommand{\mod}{~{\rm mod}~}

\begin{document}
\begin{CJK}{UTF8}{bkai}

\title{Calculation of Moon Phases and 24 Solar Terms \\ 月相和二十四節氣的計算}
\author{\href{https://publish.illinois.edu/ytliu/}{Yuk Tung Liu (廖育棟)}}
\date{2018-10-17}
\maketitle

This document explains the method used to compute the times of 
the moon phases and 24 solar terms. These times are important in the 
calculation of the Chinese calendar. See \href{../solarTerms.html}{this page} 
for an introduction to the 24 solar terms, and \href{../rules.html}{this page} for 
an introduction to the Chinese calendar calculation.

Computation of accurate times of moon phases and 24 solar terms is complicated, but today 
all the necessary resources are freely available. Anyone familiar with
numerical computation and computer programming 
can follow the procedure outlined in this document 
to do the computation.

Before stating the procedure, it is useful to have a basic understanding of 
the basic concepts 
behind the computation. I assume that readers are already familiar with 
the important astronomy concepts mentioned on \href{../rules.html}{this page}. 
In Section~\ref{sec:ET}, I briefly introduce the barycentric dynamical time (TDB) 
used in modern ephemerides, and its connection with terrestrial time (TT) and 
international atomic time (TAI). Readers who are not familiar with general 
relativity do not have to pay much attention to the formulas there. 
Section~\ref{sec:coordSys} introduces the various coordinate systems used 
in modern astronomy. Section~\ref{sec:precessionNutation} lists the formulas 
for computing the IAU~2006/2000A precession and nutation matrices. 

One important component in the computation of accurate times of moon phases 
and 24 solar terms is an accurate ephemeris of the Sun and Moon. I use the 
ephemerides developed by the Jet Propulsion Laboratory (JPL) for the 
computation. Section~\ref{sec:jpleph} introduces the JPL ephemerides
and describes how they can be downloaded and used to 
compute the positions and velocities of solar system objects. One of the 
main goals of the JPL ephemerides is for spacecraft navigation. 
Positions and velocities of the solar system objects are given in 
the international 
celestial reference system (ICRS). Hence, these data need to be transformed 
to the ecliptic coordinate system suitable for the computation of the moon phases 
and 24 solar terms. Section~\ref{sec:lighttime} describes the light-time 
correction and aberration of light. Section~\ref{sec:longitude} provides 
a step-by-step procedure for computing the apparent geocentric longitude 
of the Sun and Moon from the data computed from the JPL ephemerides. 
Section~\ref{sec:TDBtimes} describes the numerical method for computing the TDB 
times of the moon phases and 24 solar terms from the apparent geocentric 
longitudes of the Sun and Moon. Finally, Section~\ref{sec:UTC} describes 
the conversion of times between TDB and UTC+8 necessary for calendar calculation. 
For a more detailed and comprehensive introduction to the concepts 
mentioned in this document, I recommend the book 
{\it Explanatory Supplement to the Astronomical Almanac} by \expl.

\section{Ephemeris Time and Dynamical Time}
\label{sec:ET}

From the 17th century to the late 19th century, planetary ephemerides 
were calculated using time scales based on Earth's rotation. It was 
assumed that Earth's rotation was uniform. As the precision of astronomical 
measurements increased, it became clear that Earth's rotation is not uniform. 
Ephemeris time (ET) was introduced to ensure a uniform time for ephemeris calculations.
It was defined by the orbital motion of the Earth 
around the Sun instead of Earth's spin motion. However, a more precise 
definition of times is required when general relativistic effects need to be included 
in ephemeris calculations.

In general relativity, the passage of time measured by an observer depends 
on the spacetime trajectory of the observer. To calculate the motion of objects 
in the solar system, the most convenient time is a coordinate time, which does 
not depend on the motion of any object but is defined through the spacetime metric. 
In the {\em Barycentric Celestial Reference System} (BCRS), the spacetime coordinates 
are $(t,x^i)$ ($i=1,2,3$). Here the time coordinate $t$ is called the {\em barycentric 
coordinate time} (TCB). The spacetime metric for the solar system can be written as 
[see Eq.~(2.38) in \expl ]
\beq
  ds^2 = -\left( 1 - \frac{2w}{c^2} + \frac{2w^2}{c^4}\right) d(ct)^2 
- \frac{4 w_i}{c^3} d(ct) dx^i + \delta_{ij}\left[ 1 + \frac{2w}{c^2} 
+ O(c^{-4})\right] dx^i dx^j ,
\label{eq:BCRS_metric}
\eeq
where sum over repeated indices is implied. The scalar potential $w$ reduces to the 
Newtonian gravitational potential $-\Phi$ in the Newtonian limit, where 
\beq
\Phi(t,\ve{x}) = -G\int d^3x' \frac{\rho(t,\ve{x'})}{|\ve{x}-\ve{x'}|} 
\eeq
and $\rho$ is the mass density. The vector potential $w_i$ satisfies 
the Poisson equations with the source terms proportional to the momentum 
density. 

TCB can be regarded as the proper time measured by an observer far away 
from the solar system and is stationary with respect to the solar system 
barycenter. The equations of motion for solar system objects can be 
derived in the post-Newtonian framework. 
The result is a system of coupled differential equations and can be 
integrated numerically. In this framework, TCB is the natural choice of 
time parameter for planetary ephemerides. However, since most measurements 
are carried out on Earth, it is also useful to set up a coordinate system 
with origin at the Earth's center of mass. In the {\em geocentric celestial 
reference system} (GCRS), the spacetime coordinates are $(T,X^i)$, where 
the time parameter $T$ is called the {\em geocentric coordinate time} (TGC). 
GCRS is comoving with Earth's center of mass in the solar system, 
and its spatial coordinates 
$X^i$ are chosen to be kinematically non-rotating with respect to the 
barycentric coordinates $x^i$. The coordinate time TCG is chosen so that 
the spacetime metric has a form similar to equation~(\ref{eq:BCRS_metric}). 
Since GCRS is comoving with the Earth, it is inside the potential well 
of the solar system. As a result, TCG elapses {\em slower} than TCB because 
of the combined effect of gravitational time dilation and special relativistic 
time dilation. The relation between TCB and TCG is given by 
[equation~(3.25) in \expl ]
\beq
  {\rm TCB} - {\rm TCG} = c^{-2} \left[ \int_{t_0}^t \left( \frac{v_e^2}{2} 
- \Phi_{\rm ext}(\ve{x_e}) 
\right) dt + \ve{v_e} \cdot (\ve{x}-\ve{x_e})\right] + O(c^{-4}) ,
\label{eq:TCG}
\eeq
where $\ve{x_e}$ and $\ve{v_e}$ are the barycentric position and velocity of the Earth's 
center of mass, and $\ve{x}$ is the barycentric position of the observer. 
The external potential $\Phi_{\rm ext}$ is the Newtonian gravitational potential 
of all solar system bodies apart from the Earth. The constant time $t_0$ is chosen 
so that TCB=TCG=ET at the epoch 1977 January 1, 0h TAI. 

Since the definition of TCG involves only external gravity, TCG's rate is {\rm faster} 
than TAI's because of the relativistic time dilation caused by 
Earth's gravity and spin. 
The {\em terrestrial time} (TT), 
formerly called the {\rm terrestrial dynamical time} (TDT), is defined so that its rate 
is the same as the rate of TAI. 
The rate of TT is slower than TCG by $-\Phi_{\rm eff}/c^2$ on the 
\href{https://en.wikipedia.org/wiki/Geoid}{geoid} (Earth surface at mean sea level), 
where $\Phi_{\rm eff}=\Phi_E - v^2_{\rm rot}/2$ is the sum of Earth's Newtonian 
gravitational potential and the 
\href{http://scienceworld.wolfram.com/physics/CentrifugalPotential.html}{centrifugal 
potential}. Here $v_{\rm rot}$ is the speed of Earth's spin at the observer's location. 
The value of $\Phi_{\rm eff}$ 
is constant on the geoid because the geoid is defined to be an equipotential 
surface of $\Phi_{\rm eff}$. Thus, 
$d {\rm TT}/d {\rm TCG} = 1-L_G$ and $L_G$ is determined by measurements to be 
$L_G=6.969290134\times 10^{-10}$. Therefore, TT and TCG are related by a linear 
relationship [equation~(3.27) in \expl ]: 
\beq
  {\rm TT} = {\rm TCG} - L_G ({\rm JD}_{\rm TCG} - 2443144.5003725) \cdot 86400~{\rm s} ,
\label{def:TT}
\eeq
where ${\rm JD_{TCG}}$ is TCG expressed as a Julian date (JD). The 
constant 2443144.5003725 is chosen so that TT=TCG=ET at the epoch 1977 January 1 0h TAI 
(JD = 2443144.5003725). Since the rate of TT is the same as that of TAI, the two 
times are related by a constant offset:
\beq
  {\rm TT} = {\rm TAI} + 32.184~{\rm s} .
\eeq
The offset arises from the requirement that TT match ET at the chosen epoch.

TCB is a convenient time for planetary ephemerides, whereas TT can be measured 
directly by atomic clocks on Earth. The two times are related by equations~(\ref{eq:TCG}) 
and (\ref{def:TT}) and must be computed by numerical integration together with the 
planetary positions. TT is therefore not convenient for planetary ephemerides. 
The {\em barycentric dynamical time} (TDB) is introduced to approximate TT. It is 
defined to be a linear function of TCB and is set as close to TT as possible. Since 
the rates of TT and TCB are different and are changing with time, TT cannot be 
written as a linear function of TCB. The best we can do is to set the rate of 
TDB the same as the rate of TT averaged over a certain time period, so that there 
is no long-term secular drift between TT and TDB over that time period. 
The resulting deviation between TDB and TT 
has components of periodic variation caused by the eccentricity of Earth's orbit and 
the gravitational fields of the Moon and planets. TDB is now defined by the 
\href{https://www.iau.org/static/resolutions/IAU2006_Resol3.pdf}{IAU 2006 resolution 3} 
as
\beq
  {\rm TDB} = {\rm TCB} - L_B ({\rm JD_{TCB}} - 2443144.5003725)\cdot 86400~{\rm s} 
- 6.55\times 10^{-5}~{\rm s} ,
\eeq
where $L_B= 1.550519768\times 10^{-8}$ 
and ${\rm JD_{TCB}}$ is TCB expressed as a Julian date (JD). The value of $L_B$ 
can be regarded as $1-d {\rm TT}/dt$ averaged over a certain time period.

TDB is a successor of ET. It is practically equivalent to the 
\href{https://en.wikipedia.org/wiki/Ephemeris_time#JPL_ephemeris_time_argument_Teph}{JPL ephemeris time argument $T_{\rm eph}$} 
used by the Jet Propulsion Laboratory to calculate high-precision ephemerides of 
the Sun, Moon and planets. The relationship between TT and TDB 
can be written as (Figure~3.2 in \expl ] 
\beqn
  {\rm TDB} &=& {\rm TT} + 0.001658{\rm s}~\sin(g + 0.0167\sin g) \cr 
&& + \mbox{ lunar and planetary terms of order } 10^{-5}~{\rm s} \cr 
&& + \mbox{ daily terms of order} 10^{-6}~{\rm s} , 
\eeqn
where $g$ is the mean anomaly of Earth in its orbit (and hence $g+0.0167\sin g$ is the 
eccentric anomaly since 0.0167 is Earth's orbital eccentricity). 
A more detailed expression is given by equation~(2.6) in 
\kaplan. The difference 
between TDB and TT remains under 2~ms for several millennia around the 
present epoch. Thus, I treat them as the same for the calendar calculation.

\section{Celestial Coordinate Systems}
\label{sec:coordSys}

\subsection{International Celestial Reference System (ICRS)} 

As mentioned in Section~\ref{sec:ET}, the solar system metric can be 
written in the Barycentric Celestial Reference System (BCRS). The origin of the 
BCRS spatial coordinates is at the solar system barycenter, i.e.\ the center 
of mass of the solar system. However, BCRS is a dynamical concept. The 
statement of ``we use BCRS'' in general relativity is equivalent to the 
statement ``we use barycentric inertial coordinates'' in Newtonian 
mechanics. BCRS does not define the orientation of the coordinate axes.\footnote{IAU 2006 
Resolution B2 recommends that the BCRS definition is completed with the 
following: ``For all practical applications, unless otherwise
stated, the BCRS is assumed to be oriented according to the ICRS axes. 
The orientation of the GCRS is derived from the ICRS-oriented BCRS.''}

The International Celestial Reference System (ICRS) is a kinematical concept. Its 
origin is at the solar system barycenter. The ICRS axes are intended to be 
fixed with respect to space. They are 
determined based on hundreds of extra-galactic radio sources, mostly quasars, distributed 
around the sky. The ICRS axes are aligned with the equatorial system based on 
the J2000.0 mean equator and equinox to within 17.3 milliarcseconds. The $x$-axis 
of the ICRS points in the direction of the mean equinox of J2000.0. The $z$-axis 
points very close to the mean celestial north pole of J2000.0, and the $y$-axis 
is $90^\circ$ to the east of the $x$-axis on the ICRS equatorial plane. So the ICRS 
is a right-handed rectangular coordinate system. The ICRS can be transformed to the 
equatorial system of J2000.0 by the {\em frame bias matrix}, which will be 
discussed below.

It is assumed that the distant quasars and extragalactic radio sources do not 
rotate with respect to asymptotically flat reference systems like BCRS. In \
principle this assumption should be checked by testing if the motion of 
the solar system objects is compatible with the equation of motion based 
on BCRS, with no Coriolis and centrifugal forces. So far no deviations have been 
noticed. 

\subsection{Geocentric Celestial Reference System (GCRS)}

The origin of Geocentric Celestial Reference System (GCRS) is at the 
center of mass of the Earth. 
Ignoring general relativistic correction, the GCRS spatial coordinates $X^i$ 
are related to the BCRS spatial coordinates $x^i$ by 
\beq
  X^i = x^i - x^i_E ,
\label{eq:GCRSX}
\eeq
where $x^i_E$ are the BCRS coordinates of Earth's center of mass. Relativistic 
correction adds terms of order $(v_E/c)^2 \sim 10^{-8}=0.002''$. The Sun moves 
along the ecliptic with a rate of about $0.04''$ per second. The Moon moves 
faster, with a rate of about $0.5''$ per second. Thus ignoring $(v_E/c)^2$ 
correction will lead to an error of about 0.05~seconds in the computation of the 
times of 24 solar terms and about 0.004~seconds in the times of moon phases. 
These errors are much smaller than the one-second accuracy required by the 
official document \cite{pmo17}.

Like BCRS, GCRS is a dynamical concept. In the following, I will also use GCRS 
to refer to the coordinate system whose origin is at the geocenter and whose 
axes are oriented to the same directions as those of the ICRS.

\subsection{Equatorial and Ecliptic Coordinate Systems}

The orientation of the coordinate axes described above 
are fixed in space. This is convenient for describing the positions of
stars and planets. However, observations are made on Earth and hence 
coordinate systems with axes defined by Earth's spin or defined by Earth's orbital plane
are often used to describe positions of celestial objects. 
The coordinate systems whose axes are defined by Earth's spin are called 
the {\em equatorial coordinate systems}, and the coordinate system whose axes 
are defined by Earth's orbital plane are called the {\em ecliptic coordinate 
systems}.


\subsubsection{Equator, Ecliptic and Equinoxes} 

The {\em Celestial Intermediate Pole} (CIP) is the mean rotation axis of the Earth
whose motion in space contains aperiodic components as well as periodic
components with periods greater than two days. The motion of CIP is described
by precession and nutation (see below).

The {\em true equator} is defined to be the plane perpendicular to the CIP
that passes through Earth's center of mass. Thus, the true equator is constantly
changing as a result of precession and nutation. The {\em mean equator}
is the moving equator whose motion is prescribed only by precession.

{\em Ecliptic} generally refers to Earth's orbital plane projected onto the
celestial sphere. However, Earth's orbital plane is changing because of
planetary perturbation. To reduce uncertainties in the definition of the
ecliptic, the International Astronomical Union (IAU) have recommended that 
the ecliptic be defined as the plane
perpendicular to the mean orbital angular momentum vector of the Earth-Moon
barycenter passing through the Sun in the BCRS.

Equator and ecliptic intercepts at two points, called the {\em vernal equinox} and
{\em autumnal equinox}. The {\em true equinoxes} are the two points at which the true
equator and true ecliptic intercepts. The {\em mean equinoxes} are the two points
at which the mean equator and mean ecliptic intercepts.

\subsubsection{Precession, Nutation and Polar Motion}

Earth's spin axis changes its orientation in space because of
luni-solar and planetary torques on the oblate Earth.
Earth's spin axis also moves relative to the crust. This is called the
\href{https://en.wikipedia.org/wiki/Polar_motion}{\it polar motion}.

The motion of Earth's spin axis is composed of {\em precession} and {\em nutation}.
Precession is the components that are aperiodic or have periods longer
than 100 centuries. Nutation is the components that are of shorter periods
and its magnitude is much smaller. Motion with periods shorter than two days
cannot be distinguished from components of polar motion arising from the tidal
deformation of the Earth. They are considered as components of polar motion.
Therefore, nutation is defined as the periodic components in the motion of
Earth's spin axis with periods longer than two days but shorter than about 100 centuries.

The major component of precession is the rotation of Earth's spin axis about the
ecliptic pole with a period of about 26,000 years. This causes the vernal equinox
to move westward by $50.3''$ per year. The principal period of nutation
is 18.6 years, which is caused by the Moon's orbital plane precesses around
the ecliptic. The amplitude of nutation is about $9''$. The amplitude
of the polar motion is about $0.3''$.

In addition, the orbital plane
of the Earth around the Sun also moves slowly because of planetary perturbation.
Hence the ecliptic moves slowly in space. This is called the
{\em precession of the ecliptic}, to be distinguished from
the {\em precession of the equator}\footnote{Precession of the equator was
formerly called the luni-solar precession, and precession of the ecliptic
was formerly called the planetary precession. They are renamed because the
terminologies are misleading. Planetary perturbation also contributes to
the precession of the equator, although the magnitude is much smaller.}.

Polar motion is not relevant in the calculation of the Chinese calendar because 
Chinese calendar is based on the {\em geocentric} positions of the Sun and Moon, i.e.\ 
positions relative to Earth's center of mass.

\subsubsection{Equatorial ``Of Date'' Coordinates}

Equatorial coordinates are based on the equator and equinox. The $x$-axis
points to the vernal equinox. The $y$-axis lies in the equatorial plane
and is $90^\circ$ to the east of the $x$-axis. The $z$-axis points to
the celestial pole. Since equator
and equinoxes are moving, an epoch must be specified (e.g.\ J2000.0) to the coordinate
system. Equatorial coordinates based on the mean equator and equinox are called the 
{\em mean equatorial coordinates}, and those based on the true equator and equinox 
are called the {\em apparent equatorial coordinates}. 

One commonly used equatorial 
coordinate system is based on the mean equator and
equinox of J2000.0 (i.e.\ mean equator and equinox at TDB noon on January 1, 2000). 
As mentioned above, there is a small misalignment between the coordinate axes of 
the ICRS and the axes of the J2000.0 mean equatorial system. The coordinates 
in the two
systems are related by the {\em frame bias matrix} $\ve{B}$. Let $\ve{x_{\rm ICRS}}$ denotes 
a column vector representing the ICRS coordinates and $\ve{x_{2000}}$ denotes a column vector 
representing coordinates of J2000.0 mean equatorial system. Then 
\beq
  \ve{x_{2000}} = \ve{B} \ve{x_{\rm ICRS}} .
\eeq
The frame bias matrix is given by Equation~(4.4) in \expl:
\beq
  \ve{B} = \left( \begin{array}{ccc} 
1 - \frac{1}{2}(d\alpha_0^2 + \xi_0^2) & d\alpha_0 & -\xi_0 \\ 
-d\alpha_0 - \eta_0\xi_0 & 1 - \frac{1}{2}(d\alpha_0^2 + \eta_0^2) & -\eta_0 \\ 
\xi_0 - \eta_0 d\alpha_0 & \eta_0 + \xi_0 d\alpha_0 & 1 - \frac{1}{2}(\eta_0^2 + \xi_0^2) 
\end{array} \right) ,
\eeq
where $d\alpha_0 = -14.6~{\rm milliarcseconds}$, $\xi_0=-16.617~{\rm milliarcseconds}$, and 
$\eta_0=-6.8192~{\rm milliarcseconds}$. All of them have to be converted to radians.
Substituting the numbers to the formula gives 
\beq
  \ve{B} = \left( \begin{array}{ccc} 
   0.99999999999999425 & -7.078279744\times 10^{-8} & 8.05614894\times 10^{-8} \\ 
   7.078279478\times 10^{-8} & 0.99999999999999695 & 3.306041454\times 10^{-8} \\ 
   -8.056149173\times 10^{-8} & -3.306040884\times 10^{-8} & 0.999999999999996208 
  \end{array} \right) .
\label{eq:matB}
\eeq

To convert $\ve{x_{2000}}$ to the coordinates with repect to the 
true equator and equinox of date requires the multiplication of the precession 
matrix $\ve{P}(t)$ and nutation matrix $\ve{N}(t)$:
\beq
  \ve{x_{\rm eq}} = \ve{N}(t) \ve{P}(t) \ve{x_{2000}} = 
\ve{N}(t) \ve{P}(t) \ve{B} \ve{x_{\rm ICRS}} .
\eeq
The formulas for $\ve{P}(t)$ and $\ve{N}(t)$ will be given 
in Section~\ref{sec:precessionNutation} below.

\subsubsection{Ecliptic ``Of Date'' Coordinates}

The calculation of Chinese calendar requires the positions of 
the Sun and Moon in ecliptic coordinates of date. The ecliptic 
coordinate systems are based on the ecliptic and equinox. 
The $x$-axis points to the direction of the vernal equinox. 
The $y$-axis lies in the ecliptic plane and is $90^\circ$ 
to the east of the $x$-axis. The $z$-axis points to the 
ecliptic pole. Therefore, the ecliptic coordinates are 
related to the equatorial coordinates by a rotation about 
the $x$-axis by an angle $\epsilon$, which is called the 
{\it obliquity of the ecliptic} and is the angle between 
the ecliptic pole and the CIP. Note that $\epsilon=\epsilon(t)$ is a function of 
time because of precession and nutation. The value of $\epsilon$ can be 
computed by equation~(\ref{eq:epsilon}) below. Let $\ve{x_{\rm eq}}$ be 
the column vector representing the equatorial coordinates 
with respect to the true equator and equinox of date, and $\ve{x_{\rm ec}}$ 
be the column vector representing the ecliptic coordinates 
with respect to the true ecliptic and equinox of date. Then 
\beq
  \ve{x_{\rm ec}} = \ve{R_1}(\epsilon(t)) \ve{x_{\rm eq}} 
= \ve{R_1}(\epsilon(t)) \ve{N}(t) \ve{P}(t) \ve{B} \ve{x_{\rm ICRS}} ,
\label{eq:ICRS2EC}
\eeq
where the rotation matrix is 
\beq
  \ve{R_1}(\epsilon(t)) = \left( \begin{array}{ccc}
1 & 0 & 0 \\
0 & \cos \epsilon(t) & \sin \epsilon(t) \\
0 & -\sin \epsilon(t) & \cos \epsilon(t) \end{array} \right) .
\label{eq:matrixR1}
\eeq

The {\em ecliptic longitude} $\lambda$ is defined as ${\rm arg}(x_{\rm ec} + i y_{\rm ec})$, 
where ${\rm arg}(z)$ denotes the argument of the complex number $z$. 
In other words, $\lambda = \tan^{-1} (y_{\rm ec}/x_{\rm ec})$ with the 
angle in the appropriate quadrant. In many programming languages, there is 
an arctangent function (e.g.\ {\tt atan2} in FORTRAN, C and python) that returns the angle 
in the correct quadrant.

\section{Precession and Nutation}
\label{sec:precessionNutation}

\subsection{Precession Matrix}

Denote $\ve{X}=(X\ Y\ Z)^T$ the equatorial coordinates based on 
the mean equator and equinox at TDB time $t$ and $\ve{X_0}=(X_0\ Y_0\ Z_0)^T$ 
the equatorial coordinates based on the mean equator and equinox at J2000.0,
where the superscript T denotes transpose. So $\ve{X}$ and $\ve{X_0}$ are column 
vectors, and they are related by a 3D rotation described by the precession matrix 
$\ve{P}(t)$: 
\beq
  \ve{X} = \ve{P}(t) \ve{X_0} . 
\eeq

In August 2006, the 26th General Assembly for the International Astronomical Union 
passed a resolution recommending that the P03 precession theory of~\cite{capitaine03}
be used for the precession matrix. 
This model is referred to as the IAU~2006 precession theory in \iers.
According to this theory, the precession matrix is given by 
\beq
  \ve{P}(t) = \ve{R_3}(\chi_A) \ve{R_1}(-\omega_A) \ve{R_3}(-\psi_A) \ve{R_1}(\epsilon_0) ,
\label{eq:P03}
\eeq
where the rotation matrix $\ve{R_1}$ is given by equation~(\ref{eq:matrixR1}) above 
and the rotation matrix $\ve{R_3}$ is given by 
\beq
  \ve{R_3}(\theta) = \left( \begin{array}{ccc} 
\cos \theta & \sin \theta & 0 \\ 
-\sin \theta & \cos \theta & 0 \\ 
0 & 0 & 1 \end{array} \right) .
\label{eq:matrixR3}
\eeq
The angle $\epsilon_0 = 84381.406''$ is the inclination angle between the mean ecliptic and 
mean equator at J2000.0. The angles $\psi_A$, $\omega_A$ and $\chi_A$ can be found 
in equation~(5.7) in \kaplan or (5.39) and (5.40) in \iers.
They are given by 
\beqn
  \psi_A &=& 5038.481507'' T - 1.0790069'' T^2 - 0.00114045'' T^3 
+ 0.000132851'' T^4 - 9.51''\times 10^{-8} T^5 \cr 
  \omega_A &=& 84381.406'' - 0.025754'' T + 0.0512623'' T^2 - 0.00772503'' T^3 
- 4.67''\times 10^{-7} T^4 \cr && + 3.337'' \times 10^{-7} T^5 \label{eq:precessionAngles} \\ 
  \chi_A &=& 10.556403'' T - 2.3814292'' T^2 - 0.00121197'' T^3 + 0.000170663'' T^4 
- 5.60'' \times 10^{-8} T^5 ,  \nonumber
\eeqn
where $T=(JD - 2451545)/36525$ is the Julian century from J2000.0 and JD is the 
TDB Julian date number. The result of the matrix multiplication in equation~(\ref{eq:P03}) 
is also written out explicitly in equation (5.10) in \kaplan: 
\beqn
  P_{11}(t) &=& C_4 C_2 - S_2 S_4 C_3 \cr
  P_{12}(t) &=& C_4 S_2 C_1 + S_4 C_3 C_2 C_1 - S_1 S_4 S_3 \cr
  P_{13}(t) &=& C_4 S_2 S_1 + S_4 C_3 C_2 S_1 + C_1 S_4 S_3 \cr 
  P_{21}(t) &=& -S_4 C_2 - S_2 C_4 C_3 \cr 
  P_{22}(t) &=& -S_4 S_2 C_1 + C_4 C_3 C_2 C_1 - S_1 C_4 S_3 \label{eq:matP} \\
  P_{23}(t) &=& -S_4 S_2 S_1 + C_4 C_3 C_2 S_1 + C_1 C_4 S_3 \cr 
  P_{31}(t) &=& S_2 S_3 \cr 
  P_{32}(t) &=& -S_3 C_2 C_1 - S_1 C_3 \cr 
  P_{33}(t) &=& -S_3 C_2 S_1 + C_3 C_1 \nonumber
\eeqn
where 
\beqn
  S_1 = \sin \epsilon_0 & C_1 = \cos \epsilon_0 \cr 
  S_2 = \sin (-\psi_A) & C_2 = \cos (-\psi_A) \label{def:S1234} \\ 
  S_3 = \sin (-\omega_A) & C_3 = \cos (-\omega_A) \cr 
  S_4 = \sin \chi_A & C_4 = \cos \chi_A  \nonumber
\eeqn

\subsection{Nutation Matrix} 
\label{sec:nutation}

Nutation is computed according to the IAU~2000A Theory of Nutation with 
slight IAU~2006 adjustments. To construct the nutation matrix $\ve{N}(t)$, 
we need to first compute the following 14 arguments given by equations~(5.43) 
and (5.44) in \iers. 
\beqn
  F_1 \equiv l &=& \mbox{Mean Anomaly of the Moon} \cr 
 &=& 134.96340251^\circ + 1717915923.2178'' T + 31.8792'' T^2 \cr 
 && + 0.051635'' T^3 - 0.00024470'' T^4 \cr \cr 
  F_2 \equiv l' &=& \mbox{Mean Anomaly of the Sun} \cr 
  &=& 357.52910918^\circ + 129596581.0481'' T - 0.5532'' T^2 \cr 
 &&+ 0.000136'' T^3 - 0.00001149'' T^4 \cr \cr 
  F_3 \equiv &=& L-\Omega = \mbox{Mean Longitude of the Moon} - \Omega\cr 
 &=& 93.27209062^\circ + 1739527262.8478'' T - 12.7512'' T^2 \cr 
  && - 0.001037'' T^3 + 0.00000417'' T^4 \label{eq:F1to5} \\ \cr 
  F_4 \equiv D &=& \mbox{Mean Elongation of the Moon from the Sun} \cr 
&=& 297.85019547^\circ + 1602961601.2090'' T - 6.3706'' T^2 \cr 
&& + 0.006593'' T^3 - 0.00003169'' T^4 \cr \cr 
  F_5 \equiv \Omega &=& \mbox{Mean Longitude of the Ascending Node of the Moon} \cr 
&=& 125.04455501^\circ - 6962890.5431'' T + 7.74722'' T^2 \cr 
&& + 0.007702'' T^3 - 0.00005939'' T^4 \nonumber 
\eeqn
The rest of the arguments are the mean longitudes of the 8 planets and 
general precession. They are given in radians as
\beqn
  F_6 &\equiv & L_{\rm Mercury} = 4.402608842 + 2608.7903141574 T \cr \cr
  F_7 &\equiv & L_{\rm Venus} = 3.176146697 + 1021.3285546211 T \cr \cr
  F_8 &\equiv & L_{\rm Earth} = 1.753470314 + 628.3075849991 T \cr \cr
  F_9 &\equiv & L_{\rm Mars} = 6.203480913 + 334.0612426700 T \cr \cr
  F_{10} &\equiv & L_{\rm Jupiter} = 0.599546497 + 52.9690962641 T \label{eq:Fs}  \\ \cr
  F_{11} &\equiv & L_{\rm Saturn} = 0.874016757 + 21.3299104960 T \cr \cr
  F_{12} &\equiv & L_{\rm Uranus} = 5.481293872 + 7.4781598567 T \cr \cr
  F_{13} &\equiv & L_{\rm Neptune} = 5.311886287 + 3.8133035638 T \cr \cr
  F_{14} &\equiv & p_A = 0.02438175 T + 0.0000538691 T^2 \nonumber
\eeqn
Next, the nutation in longitude $\Delta \psi$ 
and nutation in obliquity $\Delta \epsilon$ are given by the expressions 
\beqn
  \Delta \psi &=& \sum_{i=1}^{1320} [A_i \sin \theta^A_i + A_i'' \cos \theta^A_i ] 
+ \sum_{i=1}^{38} [A_i' \sin \theta^{A'}_i + A_i''' \cos \theta^{A'}_i ] T 
\label{eq:DeltaPsiSum} \\ 
  \Delta \epsilon &=& \sum_{i=1}^{1037} [B_i \cos \theta^B_i + B_i'' \sin \theta^B_i ]
+ \sum_{i=1}^{19} [B_i' \cos \theta^{B'}_i + B_i''' \sin \theta^{B'}_i ] T ,
\eeqn
where the arguments of the sine and cosine functions are given by 
\beq
  \theta^A_i = \sum_{j=1}^{14} C^A_{ij} F_j \ \ , \ \ 
  \theta^{A'}_i = \sum_{j=1}^{14} C^{A'}_{ij} F_j \ \ , \ \
  \theta^B_i = \sum_{j=1}^{14} C^B_{ij} F_j \ \ , \ \
  \theta^{B'}_i = \sum_{j=1}^{14} C^{B'}_{ij} F_j  \ . 
\label{eq:thetas}
\eeq
The coefficients 
$A_i$, $A_i'$, $A_i''$, $A_i'''$, $C^A_{ij}$ and $C^{A'}_{ij}$ are listed in the table 
on the IERS ftp site \\ 
ftp://tai.bipm.org/iers/conv2010/chapter5/tab5.3a.txt. Values of 
$A_i$ and $A_i''$ are given in the second and third columns in the first 
1320 rows; $A'_i$ and $A_i'''$ are given in the second and third columns in the 
last 38 rows; $C^A_{ij}$ are given in columns 4 to 17 in the first 1320 rows; 
$C^{A'}_{ij}$ are given in columns 4 to 17 in the last 38 rows. Coefficients 
$B_i$, $B_i'$, $B_i''$, $B_i'''$, $C^B_{ij}$ and $C^{B'}_{ij}$ are given in 
the table on the IERS ftp site 
ftp://tai.bipm.org/iers/conv2010/chapter5/tab5.3b.txt. To make sure the tables are 
read correctly, I list the first few terms for $\Delta \psi$ and $\Delta \epsilon$: 
\beqn
  \Delta \psi &=& -17.20642418'' \sin \Omega + 0.003386'' \cos \Omega \cr 
&&- 1.31709122'' \sin(2F - 2D + 2\Omega) -0.0013696'' \cos (2F - 2D + 2\Omega) + \cdots 
\label{eq:DeltaPsi} \\
 \Delta \epsilon &=& 0.0015377'' \sin \Omega + 9.2052331'' \cos \Omega \cr 
  &&- 0.0004587'' \sin (2F - 2D + 2\Omega) 
+ 0.5730336'' \cos (2F - 2D + 2\Omega) + \cdots 
\eeqn

The nutation matrix $\ve{N}$ is given by the expression 
\beq
  \ve{N} = \ve{R_1}(-\epsilon) \ve{R_3}(-\Delta \psi) \ve{R_1}(\epsilon_A) ,
\label{eq:matN}
\eeq
where $\epsilon_A$ is the obliquity of the mean ecliptic of date and $\epsilon$ is the
obliquity of the true ecliptic of date. They are given by the equations
\beqn
  \epsilon_A &=& 84381.406'' - 46.836769'' T - 0.0001831'' T^2 + 0.00200340'' T^3 \cr
&& - 0.000000576'' T^4 - 0.0000000434'' T^5 \label{eq:epsA} \\
  \epsilon &=& \epsilon_A + \Delta \epsilon  \label{eq:epsilon}
\eeqn
If we are only interested in computing the components of the position 
and velocity associated 
with the true ecliptic and equinox of date, the computation can be simplified. 
From equation~(\ref{eq:ICRS2EC}) we see that the transformation involves 
$\ve{R_1}(\epsilon) \ve{N}$. 
It follows from~(\ref{eq:matN}) and $\ve{R_1}(\epsilon) \ve{R_1}(-\epsilon)=I$ (identity 
matrix) that 
\beq
  \ve{R_1}(\epsilon) \ve{N} = \ve{R_3}(-\Delta \psi) \ve{R_1}(\epsilon_A) = 
\left( \begin{array}{ccc} 
\cos \Delta \psi & -\sin \Delta \psi \cos \epsilon_A & -\sin \Delta \psi \sin \epsilon_A \\
\sin \Delta \psi & \cos \Delta \psi \cos \epsilon_A & \cos \Delta \psi \sin \epsilon_A \\ 
0 & -\sin \epsilon_A & \cos \epsilon_A \end{array} \right) .
\label{eq:RN}
\eeq
This means that it is not necessary to calculate the nutation in obliquity 
$\Delta \epsilon$.

The nutation in longitude $\Delta \psi$ is expressed by a sum over 1000 terms. 
An accuracy of $0.04''$ is necessary in order to compute the times of 24 solar 
terms to one-second accuracy required by the official document \cite{pmo17}. 
It is not necessary to include all 1000+ terms since many of them are very small. 
One possibility is to use the IAU~2000B nutation model, which is an abridged nutation model. 
IAU~2000B model contains fewer than 80 terms and its deviation from IAU~2000A model 
is less than 1~milliarcsecond  during the period 1995--2050. 
However, I include all of the 1000+ terms in IAU~2000A model 
in the calculation. Even though they substantially slow down the code, 
it still takes only about 50~seconds to compute the times of all moon phases 
(new moon, first quarter, full moon and third quarter) and all 24 solar terms 
in the years from 1600 to 3500 on my somewhat dated computer at home. This 
is still tolerable considering that 
the computation of the TDB times only needs to be carried out once for 
a given ephemeris.

\section{Jet Propulsion Laboratory Development Ephemeris}
\label{sec:jpleph}

Jet Propulsion Laboratory (JPL) development ephemeris is often 
abbreviated as JPL DE(number) or just DE(number). It refers to a particular 
ephemeris model developed by the JPL based on numerical integration. 
The main purpose of the ephemerides is for spacecraft navigation and astronomy. 
JPL has been improving their ephemerides since 1960s. The most recent, major 
upgrade was DE430 and DE431 (\cite{folkner14})
created in 2013. DE430 has been the basis of the 
\href{https://en.wikipedia.org/wiki/Astronomical_Almanac}{\it Astronomical Almanac} 
since 2015. DE431 is currently used on JPL's \href{https://ssd.jpl.nasa.gov/horizons.cgi}
{HORIZONS Web-Interface} to generate ephemerides for solar-system bodies. 
They are among the most accurate ephemerides currently available. 
I use DE431 in my calculation of moon phases and 24 solar terms for my 
\href{../calendar.html}{Chinese calendar website}. 

The DE ephemerides take into account gravitational perturbations from 
343 relatively large-mass asteroids. General relativistic effects are 
included by using dynamical equations derived from a parametrized 
post-Newtonian $n$-body metric. Additional accelerations arising 
from non-spherical effects of extended bodies including the Earth, 
Moon and Sun are also included. 

The major difference between DE430 and DE431 is that DE430 includes 
a damping term between the Moon's liquid core and solid mantle that 
gives the best fit to observation data but that is not 
suitable for backward integration of more than a few centuries. 
DE431 is similar to DE430 but without the 
core/mantle damping term, so the lunar position is less accurate than 
in DE430 for times near the current epoch, but is more suitable 
for times more than a few centuries in the past. DE431 covers 
years from -13,200 to +17,191, whereas DE430 covers years from 
1550 to 2650.

\subsection{Downloading and Reading the JPL Ephemerides}

JPL's DE ephemerides are released in files containing the 
Chebyshev polynomials fit to the rectangular positions and velocities of the 
Sun, Moon and planets. 
The coefficients of Chebyshev polynomials have a time dependence, which is first broken into
32-day intervals, and then further into a variable number of
sub-intervals, depending on the object.
The time intervals and 
orders of the Chebyshev polynomials are 
selected so that the deviations between the interpolated coordinate values 
and values provided by the ephemerides are less than 0.5 
millimeters (\cite{newhall89}). This level of interpolation 
precision is higher than the estimated accuracy of the ephemerides. 

I downloaded the DE files from JPL's ftp site 
ftp://ssd.jpl.nasa.gov/pub/eph/planets/Linux/. 
The main files are in binary format and require software to read 
and to perform interpolation. I use \href{https://www.projectpluto.com/jpl_eph.htm}
{Project Pluto's C source code} for reading the JPL ephemerides and performing 
computation. For each DE ephemeris, JPL's ftp site provides a file for checking 
values of the position and velocity coordinates of different solar system 
objects at various different times. 

I downloaded the ephemerides DE405, DE406, DE430 and DE431 from 
JPL's ftp site. The sizes of the binary files 
are 53.3MB for DE405, 190MB for DE406, 85.5MB for DE430 and 2.6GB for DE431. 
For each ephemeris I downloaded,
I went through the data in the check file and confirmed that Project Pluto's 
C code reproduces the data in the file to machine roundoff precision.

\subsection{Computing the Geometric Position and Velocity in GCRS}

Project Pluto's software contains a function that can be used to calculate 
the rectangular coordinates of the positions and velocities of the Sun, Moon, 
and planets relative to a specified object at any given TDB time using 
the coefficients of the Chebyshev polynomials from the appropriate time interval. 
The axes of the rectangular coordinate system are aligned with that of the ICRS.  
The raw data of the ephemerides are the rectangular coordinates of the positions 
and velocities of solar system objects in BCRS with axes aligned with those 
of the ICRS. I denote 
the rectangular coordinates of the position (in BCRS) of a particular object 
at a given TDB time $t$ by the vector $\ve{x}(t)$, and the 
velocity by $\ve{v}(t)$. The position and velocity of the object relative to 
a target object are simply computed from 
$\ve{X}(t)=\ve{x}(t)-\ve{x_t}(t)$ and $\ve{V}(t)=\ve{v}(t)-\ve{v_t}(t)$, 
where $\ve{x_t}(t)$ and $\ve{v_t}(t)$ are respectively the position and velocity of 
the target object in BCRS. For the calendar calculation, 
the relevant target is the Earth. The resulting vectors $\ve{X}$ and $\ve{V}$ 
represent the rectangular coordinates of the geocentric position and velocity of the 
object. These are called the {\em geometry} position and velocity. They need to be converted 
to the {\em apparent} position and velocity by taking into account the combined effect 
of light-time correction and aberration of light.

\section{Light-Time Correction and Aberration of Light}
\label{sec:lighttime}

Since the speed of light is finite, the observed position of an object is the 
object's {\em retarded position}, i.e.\ the position at which light emitted earlier 
has just reached the observer. This is called the 
\href{https://en.wikipedia.org/wiki/Light-time_correction}{\em light-time correction}. 
Let $\ve{x}(t)$ be the BCRS geometric position of the object at time $t$, and 
$\ve{x_E}(t)$ be Earth's BCRS geometric position at time $t$. Then 
the observed GCRS position at time $t$ is $\ve{X_{\rm obs}}(t) = \ve{x}(t_r) - \ve{x_E}(t)$, 
where the retarded time $t_r$ satisfies the equation 
\beq
  t_r = t - \frac{|\ve{x}(t_r) - \ve{x_E}(t)|}{c} 
\label{eq:tr}
\eeq
and $c=299792.458~{\rm km/s}$ is the speed of light. Note that the retarded time 
$t_r$ appears on both sides of equation~(\ref{eq:tr}). This means that it has to be 
solved iteratively. However, for the Sun and Moon, it is sufficient to use 
\beq
  t_r \approx t - \frac{|\ve{x}(t) - \ve{x_E}(t)|}{c} .
\eeq
By making this approximation, the error in $\ve{X_{\rm obs}}(t)$ is of 
order $(v/c)^2$, where $v=|\ve{\dot{x}}|$ is the speed of the object in BCRS. 
Since the Sun contains 99.86\% of total mass in the solar system, the motion of 
the Sun in BCRS is very small. Thus, $\ve{x}(t_r) \approx \ve{x}(t)$ for the Sun 
and $(v/c)^2$ is very tiny for the Sun. The Moon's orbital 
speed around the Earth is about 1~km/s, which is much smaller than the orbital 
speed of the Earth-Moon barycenter (about 30~km/s). Hence the speed of 
the Moon in BCRS is about 30~km/s and $(v/c)^2\sim 10^{-8}$
for the Moon. The error associated with the Moon's position is therefore 
only $0.002''$ and can be safely ignored.

\href{https://en.wikipedia.org/wiki/Aberration_of_light}{Aberration of light} 
also arises from the finite speed of light. Suppose an observer
sees an object in the direction $\ve{n}$, the direction of the object
relative to another observer moving with velocity $\ve{v}$ will be in
a direction $\ve{n'}$. The unit vectors $\ve{n}$ and $\ve{n'}$ are related
by the Lorentz transformation. In our case, $\ve{n}=\ve{X_{\rm obs}}/|\ve{X_{\rm obs}}|$ 
and $\ve{v}=\ve{\dot{x}_E}$ is Earth's velocity in BCRS.
Since Earth's orbital speed in BCRS is about 
30~km/s, it is sufficient to calculate the aberration of light to first order 
in $v/c$. When expanded to order $v/c$, the expression in the Lorentz 
transformation is the same as in Newtonian kinematics:
\beq
  \ve{n'} = \frac{\ve{n} + \ve{\beta}}{|\ve{n} + \ve{\beta}|} ,
\label{eq:aberration}
\eeq
where $\ve{\beta} = \ve{\dot{x}_E}/c$. We see that the aberration of light shifts an 
object's position by an amount of $\sim v_E/c \approx 10^{-4}\approx 20.5''$. Failure to take into 
account the aberration effect will result in an error in the times of the 
24 solar terms by about 8 minutes, which is about the time it takes for light 
to travel from the Sun to Earth. This is not a coincidence. As explained in Section~7.2.3.5 
of \expl, there is a simple method to calculate the combined effect of light-time 
correction and aberration of light, also known as the {\em planetary aberration}, to 
first order in $v/c$. I provide a derivation here.  It follows from  
$\ve{n}=\ve{X_{\rm obs}}/|\ve{X_{\rm obs}}|$ and equation~(\ref{eq:aberration}) that 
\beqn
  \ve{n'} &\propto & \frac{\ve{X_{\rm obs}}}{|\ve{X_{\rm obs}}|} + \frac{\ve{\dot{x}_E}}{c} \cr \cr 
 &=& \frac{\ve{x}(t_r) - \ve{x_E}(t)}{|\ve{x}(t_r) - \ve{x_E}(t)|} + 
\frac{\ve{\dot{x}_E}}{c} \cr \cr 
 & \propto & \ve{x}(t_r) - \left[ \ve{x_E}(t) 
- \frac{|\ve{x}(t_r)-\ve{x_E}(t)|}{c} \ve{\dot{x}_E} \right] \cr \cr 
 &\approx & \ve{x}(t_r) - \ve{x_E}\left(t - \frac{|\ve{x}(t_r)-\ve{x_E}(t)|}{c}\right) 
\cr \cr 
 &=& \ve{x}(t_r) - \ve{x_E}(t_r) .
\eeqn
Hence to first order in $v/c$, the combined effect of light-time correction and 
aberration of light results in the {\em apparent GCRS position} given by 
\beq
  \ve{X_{\rm apparent}}(t) = \ve{x}(t_r) - \ve{x_E}(t_r) .
\label{eq:apparentGCRS}
\eeq
For the Sun, $t_r$ is the time it takes for light to travel from the Sun to Earth. 
This is the reason that the aberration effect causes a correction of about 8 minutes. 
For the Moon, $t_r =1.3$~seconds, which is also substantial. Equation~(\ref{eq:apparentGCRS})
is very convenient in calculating the combined effect of light-time correction and 
aberration of light since there is a function in Project Pluto's software that 
can be used to compute $\ve{x}-\ve{x_E}$ for any solar system object at any 
given TDB time.

In addition to the apparent GCRS position, it is also useful to compute its time 
derivative. Taking the time derivative of equation~(\ref{eq:apparentGCRS}) yields 
\beq
  \ve{\dot{X}_{\rm apparent}}(t) = [ \ve{\dot{x}}(t_r) - \ve{\dot{x}_E}(t_r) ] 
\frac{dt_r}{dt} .
\label{eq:Xapparentdot1}
\eeq
Denote $D(t_r) = |\ve{x}(t_r)-\ve{x}|$ as the retarded distance and 
using~(\ref{eq:tr}), I obtain 
\beq
  \frac{dt_r}{dt} = 1 - \frac{\dot{D}(t_r)}{c} \frac{dt_r}{dt}
\ \ \Rightarrow \ \ \frac{dt_r}{dt} = \frac{1}{1+v_r(t_r)/c} , 
\eeq
where $v_r =dD/dt$ is the radial velocity of the object relative to Earth. 
Equation~(\ref{eq:Xapparentdot1}) can be written as 
\beq
  \ve{\dot{X}_{\rm apparent}}(t) = \frac{\ve{\dot{x}}(t_r) - \ve{\dot{x}_E}(t_r)}{1+v_r(t_r)/c}
\eeq
The denominator in the above expression is the cause of 
the apparent \href{https://en.wikipedia.org/wiki/Superluminal_motion}{superluminal motion} 
of jets in some active galaxies: if a jet moving close to the speed of light
is moving at a very small angle towards the observer, $1+v_r/c \ll 1$ and
it is possible to have the apparent speed greater than the speed of light. 
However, $v_r/c$ is negligible for the Sun and Moon because both Earth's orbit around the Sun 
and Moon's orbit around Earth are nearly circular. The radial speed 
$|v_r| \sim 0.5$~km/s for the Sun and $|v_r| \sim 0.05$~km/s for the Moon. 
Hence the fractional error in ignoring the $v_r/c$ term is of order $10^{-6}$ for 
the Sun and $10^{-7}$ for the Moon. As will be explained in Section~\ref{sec:TDBtimes}, 
this error has almost no effect on the accuracy of the times of moon phases 
and 24 solar term. I therefore ignore it and set 
\beq
  \ve{\dot{X}_{\rm apparent}}(t) = \ve{\dot{x}}(t_r) - \ve{\dot{x}_E}(t_r) 
= \ve{v}(t_r) - \ve{v_E}(t_r) .
\label{eq:Xapparentdot2}
\eeq
This is also a very convenient equation to compute $\ve{\dot{X}_{\rm apparent}}$ 
since there is a function in Project Pluto's software that can be used to 
compute $\ve{v}-\ve{v_E}$ for any solar system object at any given TDB time.

\section{Apparent Geocentric Longitude}
\label{sec:longitude}

The apparent geocentric longitude of the Sun and Moon are crucial in the computation 
of the times of moon phases and 24 solar terms. The longitude can be computed by
combining the equations in Sections~\ref{sec:coordSys}, \ref{sec:precessionNutation}
and \ref{sec:lighttime}. Here are the steps of the calculation for a given 
TDB time $t$:
\begin{enumerate}
\item Compute the geometric position of the object (Sun or Moon) in GCRS 
by $\ve{X_{\rm geometric}}(t) = \ve{x}(t) - \ve{x_E}(t)$, where 
$\ve{x}$ is the BCRS position of the object and $\ve{x_E}$ is the BCRS 
position of the Earth. 

\item Compute the retarded time approximately using 
$t_r \approx t - |\ve{X_{\rm geometric}}(t)|/c$.

\item Compute the apparent geocentric position using the equation 
$\ve{X_{\rm apparent}}(t) \approx \ve{x}(t_r) - \ve{x_E}(t_r)$. 
The resulting vector gives the components in the GCRS coordinate system. 
Recall that the origin of the GCRS is at the geocenter and its axes 
are aligned with those of the ICRS.

\item Calculate the precession matrix $\ve{P}(t)$ using 
equations~(\ref{eq:precessionAngles}), (\ref{eq:matP}) and (\ref{def:S1234}). 
Calculate the matrix $\ve{R_1}(\epsilon(t)) \ve{N}(t)$ using 
equations~(\ref{eq:F1to5})--(\ref{eq:DeltaPsiSum}), (\ref{eq:thetas}), (\ref{eq:epsA}) 
and (\ref{eq:RN}).

\item Convert the GCRS apparent geocentric position $\ve{X_{\rm apparent}}(t)$ to 
the apparent geocentric position in coordinates associated with the 
true ecliptic and equinox of date using the equation 
\beq
  \ve{X_{\rm ec}}(t) = \ve{R_1}(\epsilon(t)) \ve{N}(t) \ve{P}(t) \ve{B} 
\ve{X_{\rm apparent}}(t) ,
\label{eq:Xec}
\eeq
where the frame bias matrix $\ve{B}$ is given by equation~(\ref{eq:matB}).

\item Calculate the apparent geocentric longitude using 
$\lambda = {\rm arg}(X_{\rm ec} + i Y_{\rm ec})$. That is, 
$\lambda = \tan^{-1}(Y_{\rm ec}/X_{\rm ec})$ in the appropriate quadrant.
\end{enumerate}

It is also useful to calculate the time derivative of $\lambda$. Differentiating 
$\lambda(t)=\tan^{-1}[Y_{\rm ec}(t)/X_{\rm ec}(t)]$ yields
\beq
  \dot{\lambda}(t) = \frac{X_{\rm ec} \dot{Y}_{\rm ec} - Y_{\rm ec} \dot{X}_{\rm ec}}
{X_{\rm ec}^2 + Y_{\rm ec}^2}  .
\eeq
The time derivatives $\dot{X}_{\rm ec}$ and $\dot{Y}_{\rm ec}$ are obtained by 
differentiating equation~(\ref{eq:Xec}) with respect to $t$:
\beq
  \ve{\dot{X}_{\rm ec}}(t) = \ve{R_1}(\epsilon(t)) \ve{N}(t) \ve{P}(t) \ve{B} 
\ve{\dot{X}_{\rm apparent}}(t) + \frac{d}{dt}\left[\ve{R_1}(\epsilon(t)) \ve{N}(t) \ve{P}(t) 
\right] \ve{B} \ve{X_{\rm apparent}}(t) .
\label{eq:dXec_dt}
\eeq
The first term arises from the fact that the object is moving relative to Earth; 
the second term arises from the fact that the coordinate axes associated with  
the true ecliptic and equinox of date are moving because of precession and 
nutation. Obviously the first term is the dominant term and the second term can be 
ignored. Hence, 
\beq
  \ve{\dot{X}_{\rm ec}}(t) \approx \ve{R_1}(\epsilon(t)) \ve{N}(t) \ve{P}(t) \ve{B}
\ve{\dot{X}_{\rm apparent}}(t) = \ve{R_1}(\epsilon(t)) \ve{N}(t) \ve{P}(t) \ve{B} 
[\ve{v}(t_r) - \ve{v_E}(t_r)] .
\eeq
Let's perform an order of magnitude estimate of the error in dropping the second term. 
The sidereal period of 
the Earth around the Sun is 365.2564 days. This means that the Sun completes a 
full circle as seen on Earth in the GCRS coordinates in 365.2564 days. So 
in one day, the Sun moves, on average, about $360^\circ/365.2564 \approx 1^\circ$. 
Hence $|\ve{\dot{X}_{\rm apparent}}|/|\ve{X}_{\rm apparent}| \approx 1^\circ$/day 
for the Sun. The Moon's sidereal period around Earth is 27.3217 days. Similar 
calculation shows 
$|\ve{\dot{X}_{\rm apparent}}|/|\ve{X}_{\rm apparent}| \approx 13^\circ$/day 
for the Moon. The major component of precession is the westward motion 
of the vernal equinox at a rate of $50.3''$/year, which is about $0.14''$/day. 
Hence, $|\ve{\dot{P}}|\sim 0.14''$/day. Here $|\ve{\dot{P}}|$ means 
the (maximum) magnitude of the components in the $\ve{\dot{P}}$ matrix. 
The major component of nutation is 
the 18.6~year cycle caused by Moon's orbital plane precessing around the ecliptic. 
This is represented by the first term in equation~(\ref{eq:DeltaPsi}). So 
$|d(\ve{R_1(\epsilon)N})/dt|\sim 17.2'' |\dot{\Omega}|$ and from equation~(\ref{eq:F1to5}) 
we have $|\dot{\Omega}| \approx 7000000''/{\rm century} \approx 10^{-3}~{\rm rad/day}$. 
Hence $|d(\ve{R_1(\epsilon)N})/dt|\sim 0.02''$/day. Thus, not surprisingly precession is 
the dominant component in the second term, but $|\ve{\dot{P}}|/|\ve{X}_{\rm apparent}| 
\sim 4\times 10^{-5}$ for the Sun and $\sim 3\times 10^{-6}$ for the Moon. 
Therefore, dropping the second term introduces a fractional error of order 
$4\times 10^{-5}$ for the Sun and $3\times 10^{-6}$ for the Moon. As will be 
explained in the next section, this error has almost no effect on the accuracy 
in the times of the moon phases and 24 solar terms.

\section{Computation of the TDB Times of Moon Phases and 24 Solar Terms} 
\label{sec:TDBtimes}

The 24 solar terms are defined when the apparent geocentric longitude of the 
Sun reaches integer multiples of $15^\circ$ or $\pi/12$ radians. Hereafter, 
all angles are assumed to be in radians. New moon (lunar conjunction) 
is defined when the apparent geocentric longitude of the Moon $\lambda_M$ is 
equal to the apparent geocentric longitude of the Sun $\lambda_S$. First 
quarter is defined when $P(\lambda_M-\lambda_S) = \pi/2$; 
full moon is defined when $P(\lambda_M-\lambda_S) = -\pi$; 
third quarter is defined when $P(\lambda_M-\lambda_S) = -\pi/2$. 
Here the function $P$ is defined as 
\beq
  P(x) \equiv x - 2\pi \left[ \frac{x+\pi}{2\pi}\right] 
\eeq
and $[x]$ means the largest integer less than or equal to $x$. Thus, the 
operator $[\ ]$ is the same as the {\tt floor} function in C and python. 
The function $P$ simply adds an integer multiples of $2\pi$ to bring the 
argument into the interval $[-\pi,\pi)$.
Computation of the times of moon phases and 24 solar terms therefore boils 
down to finding the roots of $f(t)=0$. The function $f$ is listed in the tables 
below for computing the moon phases and 24 solar terms. Note that both $\lambda_S$ 
and $\lambda_M$ are functions of $t$.
\vskip 5mm
\begin{tabular}{cc}
\hline
 Moon Phase & Function $f$ \\
\hline 
 new moon & $P(\lambda_M - \lambda_S)$ \\ 
 first quarter & $P(\lambda_M - \lambda_S - \pi/2)$ \\ 
 full moon & $P(\lambda_M - \lambda_S - \pi)$ \\
 third quarter & $P(\lambda_M - \lambda_S + \pi/2)$ \\
\hline
\end{tabular}
\vskip 5mm
\begin{tabular}{cc|c|cc}
\hline
 Solar Term & Function $f$ & & Solar Term & Function $f$ \\
\hline
  J1 (立春) & $P(\lambda_S + \pi/4)$ & & Z1 (雨水) & $P(\lambda_S + \pi/6)$  \\ 
  J2 (驚蟄) & $P(\lambda_S + \pi/12)$ & & Z2 (春分) & $P(\lambda_S)$ \\
  J3 (清明) & $P(\lambda_S - \pi/12)$ & & Z3 (穀雨) & $P(\lambda_S - \pi/6)$ \\
  J4 (立夏) & $P(\lambda_S - \pi/4)$ & & Z4 (小滿) & $P(\lambda_S - \pi/3)$ \\
  J5 (芒種) & $P(\lambda_S - 5\pi/12)$ & & Z5 (夏至) & $P(\lambda_S - \pi/2)$ \\ 
  J6 (小暑) & $P(\lambda_S - 7\pi/12)$ & & Z6 (大暑) & $P(\lambda_S - 2\pi/3)$ \\
  J7 (立秋) & $P(\lambda_S - 3\pi/4)$ & & Z7 (處暑) & $P(\lambda_S - 5\pi/6)$ \\
  J8 (白露) & $P(\lambda_S - 11\pi/12)$ & & Z8 (秋分) & $P(\lambda_S - \pi)$ \\ 
  J9 (寒露) & $P(\lambda_S + 11\pi/12)$ & & Z9 (霜降) & $P(\lambda_S + 5\pi/6)$ \\
  J10 (立冬) & $P(\lambda_S + 3\pi/4)$ & & Z10 (小雪) & $P(\lambda_S + 2\pi/3)$ \\
  J11 (大雪) & $P(\lambda_S + 7\pi/12)$ & & Z11 (冬至) & $P(\lambda_S + \pi/2)$ \\ 
  J12 (小寒) & $P(\lambda_S + 5\pi/12)$ & & Z12 (大寒) & $P(\lambda_S + \pi/3)$ \\
\hline
\end{tabular}

\subsection{Newton-Raphson Method}

In our case, the best method for finding the roots of $f(t)=0$ is the Newton-Raphson 
method. This is an iterative scheme. Suppose $t_n$ is the approximate value of 
a root in the $n$th iteration. The improved approximation in the $(n+1)$th iteration 
is given by the equation 
\beq
  t_{n+1} = t_n - \frac{f(t_n)}{\dot{f}(t_n)} 
\eeq
This scheme requires the time derivative of $f$, which is $\dot{\lambda}_S$ for 
24 solar terms and $\dot{\lambda}_M - \dot{\lambda}_S$ for moon phases. They can be 
computed using the method described in the previous section. An initial guess is 
required to start the iteration. 
This turns out to be very easy. We know that the motion of the Sun and 
Moon are fairly uniform because of the low eccentricity of the Earth's orbit around 
the Sun and the low eccentricity of the Moon's orbit around the Earth. As a result, 
both $\dot{\lambda}_S$ and $\dot{\lambda}_M$ do not change significantly and can be 
used to calculate the approximate time when $\lambda_S$ or $\lambda_M-\lambda_S$ 
reaches a certain value. Suppose we want to find a root of $f(t)=0$ close to 
a given TDB time $t_0$. We can simply set $t_1 = t_0 - f(t_0)/\dot{f}(t_0)$. 
However, it is an approximation to 
{\em a root} since we know $f(t)=0$ have multiple roots in our cases. Sometimes 
we may want to find a specific root, e.g.\ the first new moon before a particular 
winter solstice or the first full moon after a particular new moon. In cases like 
these, we want to find the first root before or after a given TDB time $t_0$. We can 
modify the initial guess $t_1$ according to the following equation:
\beq
  t_1 = t_0 - \frac{f(t_0)}{\dot{f}(t_0)} + \frac{2k\pi}{\dot{f}(t_0)} ,
\eeq
where $k$ is an integer that takes the value of 0, 1 or $-1$. As mentioned above, 
$\dot{f}$ is close to being a constant. In the case of 24 solar terms, 
$2\pi/\dot{f}$ is close to a tropical year (365.2422~days). In the case of 
moon phases, $2\pi/\dot{f}$ is close to a synodic month (29.5306~days). 
Hence, the addition of $2k\pi/\dot{f}(t_0)$ is just to add/subtract 
a period to the original guess $t_0 - f(t_0)/\dot{f}(t_0)$. It works 
as follows. 

\begin{description}
\item[Case 1:] Want to find the first root {\em before} $t_0$. In this case, we want
$t_1<t_0$. Hence if $f(t_0) >0$ set $k=0$; if $f(t_0) <0$ set $k=-1$. (Note that
$f(t_0) \in [-\pi,\pi)$ and $\dot{f}(t_0) > 0$ for both moon phases and 24 solar terms.)

\item[Case 2:] Want to find the first root {\em after} $t_0$. In this case, we want
$t_1>t_0$. Hence if $f(t_0) >0$ set $k=1$; if $f(t_0) <0$ set $k=0$.
\end{description}

Once $t_1$ is determined, the iteration procedure can be started. The sequence $\{t_n\}$ 
converges very rapidly. I stop the process at iteration $m$ when $|t_m-t_{m-1}|<\varepsilon$
and I set $\varepsilon=10^{-8}~{\rm days}=0.864~{\rm milliseconds}$. This convergence 
criterion is equivalent to setting $|f(t_{m-1})/\dot{f}(t_{m-1})| < \varepsilon$. 

Newton-Raphson method turns out to be very effective in the computation of the times 
of moon phases and 24 solar terms. After setting $t_1$, the method converges to 
the required accuracy within 3 or 4 iterations. As a result, it only takes about 50~seconds 
to compute all the times of the 4 moon phases and all 24 solar terms from years 1600 
to 3500 using my somewhat old computer at home. In the early development of my 
code, I did not simplify the calculation of the matrix $\ve{R_1}(\epsilon)\ve{N}$ 
as described in Section~\ref{sec:precessionNutation} and computed 
the nutation in obliquity $\Delta \epsilon$ 
as well. It took about 90~seconds to do the same calculation. The series involving 
$\Delta \epsilon$ contains 1056 terms involving trigonometric functions. The series 
involving $\Delta \psi$ contains 1358 terms of trigonometric functions. When I 
only kept a few terms in $\Delta \psi$ and $\Delta \epsilon$, the computation 
finished in a few seconds. From this 
information I conclude that most of the computation time is spent in 
computing $\Delta \psi$. This is probably not true if I had used a semi-analytic 
ephemeris such as \href{http://neoprogrammics.com/vsop87/}{VSOP87} or 
\href{http://adsabs.harvard.edu/abs/2003A%26A...404..735C}{ELP/MPP02}, which involves 
Poisson series containing thousands of terms. This is the advantage of using 
the JPL ephemerides since the positions and velocities are simply computed 
by interpolation of the tabulated values using the Chebyshev polynomials. 
The computation is much faster and the result is more accuarte than other 
semi-analytic theories. One disadvantage of the JPL ephemerides is that they 
require large data files in order for the interpolation to produce highly 
accurate data. However, even the largest data file (for DE431) is about 2.6GB, which 
is not much in today's computation world. Another disadvantage is that it is not 
possible to extrapolate to times beyond the time span covered by the ephemerides. 
For DE431, the time span is from years -13,200 to 17,191, which should be adequate 
for many applications.

As mentioned above, my criterion for convergence is equivalent to setting 
$|f(t)/\dot{f}(t)|<\varepsilon$. Hence the accuracy is mainly determined by how 
close $f(t)$ is towards 0. The role of $\dot{f}$ is to provide a conversion 
factor between the deviation of $|f(t)|$ from 0 to the error in the computed time. 
I mention in the previous sections that there is some error in the computation 
of $\dot{f}$ because I drop some terms. In particular, dropping the factor 
$dt_r/dt$ in equation~(\ref{eq:Xapparentdot1}) introduces a fractional error of 
$\sim 10^{-6}$ for the Sun and $\sim 10^{-7}$ for the Moon. Dropping the second term 
in equation~(\ref{eq:dXec_dt}) introduces a fractional error of $\sim 4\times 10^{-5}$ 
for the Sun and $\sim 3\times 10^{-6}$ for the Moon. Since the accuracy is 
set by $|f(t)/\dot{f}(t)|<\varepsilon$, error in $\dot{f}$ is equivalent to changing 
$\varepsilon$. Thus, a fractional error of $10^{-4}$ is the same as changing 
$\varepsilon$ to $1.0001 \varepsilon$ in the worse cases. 
For $\varepsilon=10^{-8}~{\rm days}=0.864$~ms, 
that is the difference between 0.864~ms and 0.8640864~ms. Therefore, the accuracy 
of the computed times is almost independent of the small error in $\dot{f}$. Even 
a 10\% error in $\dot{f}$ is harmless as long as $\varepsilon$ is set to a much 
smaller value than the target accuracy. Since I know $\dot{f}$ is nearly constant, 
I tried setting it to its average value just out of curiosity. So 
I tried $\dot{f}=2\pi/29.5306{\rm days}$ for the moon phase calculation and 
$\dot{f}=2\pi/365.2422{\rm days}$ for the solar term calculation. When compared 
to the calculation using accurate $\dot{f}$, I find a maximum deviation of 0.16~ms 
for the 24 solar terms and 0.24~ms for moon phases from years 1600 to 3500. These 
are all smaller than the prescribed $\varepsilon$. However, this does not mean 
that accurate values of $\dot{f}$ are useless because even though the accuracy does 
not suffer, the number of iterations required to reach convergence increase. 
Using these inaccurate values of $\dot{f}$ takes 
up to 7 iterations for the solar term calculation to converge to the required accuracy, 
and up to 12 iterations for the moon phase calculation to converge, causing a significant 
slowdown in the calculation. It is well-known that Newton-Raphson method is a second-order 
scheme, which converges much faster than first-order root-searching schemes. 
However, it is only second order if the derivative is accurate. Computing $\dot{f}$ 
is very straightforward since velocities are output quantities in the JPL 
ephemerides.

\subsection{Comparison with Different Ephemerides and with a Different 
Precession Model} 

I have computed the TDB times of the moon phases and 24 solar terms 
using JPL's DE431, DE430 and DE406. As mentioned above, the only difference 
between DE430 and DE431 is that DE430 includes a damping term between the Moon's 
liquid core and solid mantle that gives the best fit to observation data but
not suitable for backward integration of more than a few centuries. JPL recommends 
using DE430 for times within few hundred years from J2000.0 and DE431 for 
earlier and later periods. 
Comparing the computed times of moon phases and 24 solar terms between DE430 and 
DE431, I find a maximum difference of 0.000419~s ($<\varepsilon$) in 
24 solar terms and 0.85~s 
in moon phases between years 1600 and 2500. The maximum differences between 
years 1900 and 2200 are 0.00015~s ($<\varepsilon$) in 24 solar terms and 0.2~s in moon phases. 
Note that the maximum deviations in the times of 24 solar terms are less than the prescribed 
convergence criterion $\varepsilon=0.000864$~s and so there is essentially no difference 
in the times of 24 solar terms.

DE405 was released in 1998 and was the basis for the 
\href{https://en.wikipedia.org/wiki/Astronomical_Almanac}{Astronomical Almanac} from 
2003--2014. DE406 was released at the same time as DE405. It was a condensed version 
of DE405. The integration method used in DE406 was the same as that of DE405, but 
the accuracy of the interpolating polynomials has been lessened to 
reduce file size for the longer time span covered by the file. Comparing 
the computed times of moon phases and 24 solar terms between DE406 and DE431, 
I find maximum deviations of 0.14~s in 24 solar terms and 0.18~s in moon 
phases for years between 1600 and 2500.

As pointed out in~\cite{VCW}, the IAU~2006 precession model is only 
accurate within about 1000~years from J2000.0. In the paper the authors developed
a new precession model that can be used within 200 millennia from J2000.0.  
This precession model is adopted by the popular open-source planetarium 
software \href{https://stellarium.org/}{Stellarium}. I also 
use it for my \href{https://ytliu0.github.io/starCharts/}{star chart website}. 
Since I compute times up to the year 3500, I want to investigate the 
difference between the new precession model and IAU~2006. I compute 
the times of the moon phases and 24 solar terms using DE431 and the 
new precession model for years from 1600 to 3500, and then compare them to the 
times calculated using DE431 and IAU~2006 precession model. 
I find maximum deviations of 0.19~s in 24 solar 
terms and 0.00038~s ($<\varepsilon$) in moon phases for years between 1600 and 2500, but 
the maximum deviations go up to 3~s in 24 solar terms and 0.0035~s in 
moon phases when comparing the times for years from 1600 to 3500.

Based on these comparisons, I estimate that the TDB times of the computed moon 
phases and 24 solar terms using DE431 and IAU~2006 precession model are 
probably accurate to better than 0.2~s for years 
between 1901 and 2200, which is the time span covered in my 
\href{../calendar.html}{Chinese calendar website}.

\subsection{Text File for the TDB Times}

Even though the computation of the TDB times of moon phases and 24 solar terms 
is complicated, they only need to be done once for a given ephemeris 
and precession-nutation model. I created a text file in ASCII format 
storing these times computed from DE431 with IAU~2006/2000A precession-nutation 
model for years between 1600 and 3500. The file is {\tt TDBtimes.txt}, available 
on \href{https://github.com/ytliu0/ChineseCalendar}{my GitHub repository}. 
It is designed for use in the calculation of 
Chinese calendar.

The file contains 1901 rows and 87 columns. The first column is the 
Gregorian year. The second column is the Julian date number on 
January -1 of the year at 16:00 TDB, or January 0 of the year at 0:00 (TDB+8). 
For example, the {\tt jd0} in the year 2000 is 2451543.166666667. This was 
the Julian date number on January -1, 2000 at 16:00 TDB (December 30, 1999 at 16:00 TDB). 
The value of {\tt jd0} is always an integer plus 1/6 because the TDB time is always 16:00. 
{\tt jd0} is the time origin from which the times in the rest of the columns are measured. 
That is, the Julian date numbers of the times in the rest of the columns are 
{\tt jd0} + values listed in those columns. 

The third column, labelled {\tt Z11a}, is the time of the first winter solstice 
{\em before} {\tt jd0}, i.e.\ the time of the December solstice in the previous year. 
For example, the third column in year 2000 is $-8.343841734507215$. This means that 
the December solstice in 1999 occurred at the TDB Julian day 
$2451543.166666667-8.343841734507215$, which was December 22, 1999 at 7:44:52 TDB. 
Columns 4--27 are the 24 solar terms in the year, starting from J12 (小寒) and 
ending with Z11 (labelled {\tt Z11b}), the December solstice in the year. 
Therefore, the time listed in column {\tt Z11b} is the same as the time listed 
in {\tt Z11a} in the following year. Their values are different simply because they 
are measured from different time origins.

Column 28, labelled {\tt Q0\_01}, is the time of the first new moon occurring {\em before} 
the winter solstice listed in the {\tt Z11a} column. The remaining columns 
(Columns 29--87) are the times of the first quarters (labelled {\tt Q1\_xx}), 
full moons (labelled {\tt Q2\_xx}), third quarters (labelled {\tt Q3\_xx}) and 
other new moons (labelled {\tt Q0\_xx}) in chronological order. Here xx 
ranges from 01 to 15 representing the lunation number counting from the new moon 
in column 28. Each year lists the four moon phases covering 15 lunations.

The data structure of the file is designed for convenience in the computation of 
the Chinese calendar in the {\it su\`i} from the winter solstice of the previous 
Gregorian year to the winter solstice of the current Gregorian year. The new moon 
listed in the {\tt Q0\_01} column is usually but not always associated with 
month 11 in the Chinese calendar. Even though by definition the new moon in 
the {\tt Q0\_02} column must occur after the winter solstice, it could happen that 
it is on the same day as the winter solstice if it occurs only a few hours 
later than the winter solstice. If that is the case, it is the new moon in 
the {\tt Q0\_02} column that is associated with month 11. To determine if 
this is the case requires the knowledge of the beginning and ending of a day. 
The Chinese calendar uses UTC+8 to define a day, so we will need to know 
the conversion between TDB and UTC to determine accurately if that is the case. 
A {\it su\`i} can contain up to 13 Chinese months, which requires 14 new moons 
to determine the number of days in each of the 13 months. If month 11 starts 
on the date of the second new moon, it must be on the same day as the winter 
solstice. It is easy to show that the {\it su\`i} can only have 12 months 
in that case. 
So in all cases 14 new moons are sufficient to determine all months in a {\it su\`i}. 
Listing moon phases covering 15 lunations is more than enough for the calendar 
calculation, and there are some overlaps between the moon phases listed in a year 
and those listed in the previous and the following year.

\section{Conversion Between TDB and UTC}
\label{sec:UTC}

The choice of separating
the computation of times in TDB and conversion between TDB and UTC is
deliberate. The computation of the TDB times is complicated but only need to be
done once for any given ephemeris and precession-nutation model. The conversion
between TDB and UTC is constantly modified as new data become available.
By separating the two procedures, each time the conversion between TDB and UTC
is modified, we just need to change the conversion and do not need to recompute
the times of moon phases and 24 solar terms. If the UTC+8 times were given 
in the text file {\tt TDBtimes.txt}, it would become
outdated when a modified conversion emerges. 

UTC was invented in 1960. There were several changes in UTC until it was 
finalized in 1972. To prevent confusion, I use 
UT1+8 for times before 1972. Conversion between TDB and TT is ignored 
because the deviations between the two times are less than 0.002~s 
over several millennia. For years before 1972, values of 
$\Delta T ={\rm TT-UT1}$ are 
calculated using the analytic fitting formula by \cite{deltaT}.
So UT1 is obtained by simply subtracting $\Delta T$ from TDB. 
For years from 1972 to the present day, I use a table of published leap seconds 
(e.g.\ \href{https://en.wikipedia.org/wiki/Leap_second}
{https://en.wikipedia.org/wiki/Leap\_second}) to calculate ${\rm TT-UTC}$. 
Specifically, 
\beq
  {\rm TT-UTC} = 42.184~{\rm s} + 
\mbox{total number of leap seconds added to UTC since 1972} .
\eeq
For the future years, I use the extrapolation formulas for $\Delta T$ by \cite{deltaT}
to extrapolate the value of ${\rm TT-UTC}$. By construction, $|{\rm UTC-UT1}|<0.9$~s, 
so the error in setting ${\rm TT-UTC}$ to $\Delta T$ is probably less than 
the error in the extrapolation formulas. In the following I give two examples 
to demonstrate how the conversion works. 

{\bf Example 1}: From the text file {\tt TDBtimes.txt}, the 
first new moon in the year 2018 is the new moon in the {\tt Q0\_02} column (column 32). 
The TDB time of the new moon is 17.42943724648089~days from January~0, 2018 at 00:00 
(TDB+8), which is January 17, 2018 at 10:18:23.378 (TDB+8). According to the leap 
second table, the total number of leap seconds added to UTC in 2018 is 27~s. Hence 
${\rm TT-UTC} = 69.184$~s. Subtracting 69.184~s from the TDB+8 time above, 
I find the new moon occurred on January 17, 2018 at 10:17:14 
(UTC+8). This is consistent with the time listed in 
\href{http://aa.usno.navy.mil/publications/reports/ap18_for_web.pdf}{\it Astronomical 
Phenomena for the year 2018} (January 17, 2018 at 02:17 UTC) published jointly by 
The Nautical Almanac Office 
and Her Majesty's Nautical Almanac Office. This is not surprising since the 
astronomical data of the book are based on DE430 and the time differences of the 
moon phases 
calculated by DE431 and DE430 are less than 0.2~s in the period 1901--2200 as 
mentioned in the previous section.

{\bf Example 2}: From the text file {\tt TDBtimes.txt}, the new moon listed 
in the column {\tt Q0\_11} is 272.0013125274384~days from January 0, 2057 at 
00:00 (TDB+8), which is September 29, 2057 at 00:01:53.402 (TDB+8). 
Using the extrapolation formula by \cite{deltaT}
I find $\Delta T = 108.875$~s in September 2057. Setting 
${\rm TT-UTC}\approx 108.875$~s and subtracting it from the TDB+8 time above
gives the new moon occurring on September 29, 2057 at 00:00:4.5 (UTC+8). 
This is just 4.5~s past midnight! If the extrapolation is off by more than 5~s, 
this new moon may actually occur on September 28, 2057. This new moon is 
associated with month 9 in the Chinese calendar. Therefore, it is currently 
not possible to determine the exact start day of month 9 in 2057. We just 
have to wait for the time to come to get a better handle on the situation.

As we see, the conversion between TDB and UTC depends on the number of 
leap seconds added to UTC. It is very difficult, if not impossible, to 
predict accurately how many leap seconds will be added to UTC decades from now because 
of the irregularity of Earth's rotation. The situation may also be complicated 
by the uncertainty of the leap-second policy in the future: there have been 
\href{https://en.wikipedia.org/wiki/Leap_second#Proposal_to_abolish_leap_seconds}
{discussions on the abolishment of leap seconds} since 2005.

\begin{thebibliography}{Urban \& Seidelmann 2013}

\bibitem[Capitaine et al 2003]{capitaine03} N.~Capitaine, P.T.~Wallace, 
and J.~Chapront, ``Expressions for IAU 2000
precession quantities'', Astron.\ Astrophys., 412(2), pp. 567-586, 2003,
\href{https://www.aanda.org/articles/aa/abs/2003/48/aa4068/aa4068.html}
{doi:10.1051/0004-6361:20031539}.

\bibitem[Espenak and Meeus]{deltaT} ``Polynomial Expressions for Delta T'' on 
\href{https://eclipse.gsfc.nasa.gov/SEcat5/deltatpoly.html}{https://eclipse.gsfc.nasa.gov/SEcat5/deltatpoly.html}.

\bibitem[Folkner et al 2014]{folkner14} W.M.~Folkner et al, 
\href{https://naif.jpl.nasa.gov/pub/naif/generic_kernels/spk/planets/de430_and_de431.pdf}{``The Planetary and Lunar Ephemerides DE430 and DE431''}, 
IPN Progress Report 42-196, February 15, 2014.

\bibitem[GB/T 33661-2017]{pmo17} \href{http://www.nongli.net/cn/11028.html}{《農曆的編算和頒行
》}
(``Calculation and promulgation of the Chinese calendar''), revised version (June 28, 2017),
issued jointly by General Administration of Quality Supervision,
Inspection and Quarantine of the People's Republic of China and
Standardization Administration of the People's Republic of China,
drafted by Purple Mountain Observatory. PDF version of the draft can be downloaded
on \href{https://www.biaozhun.org/A/22300.html}{https://www.biaozhun.org/A/22300.html}.

\bibitem[IERS Conventions 2010]{iers2010} \href{http://iers-conventions.obspm.fr/2010/2010_official/tn36.pdf}{IERS Conventions 2010}, 
edited by G.~Petit and B.~Luzum.

\bibitem[Kaplan 2005]{kaplan05} G.H. Kaplan, \href{http://aa.usno.navy.mil/publications/docs/Circular_179.pdf}
{``The IAU Resolutions on Astronomical Reference Systems, Time Scales, 
and Earth Rotation Models: Explanation and Implementation''}, U.S. Naval 
Observatory Circular No. 179, U.S. Naval Observatory, Washington, D.C. 20392 (2005).

\bibitem[Newhall 1989]{newhall89} X.X.~Newhall, 
\href{http://adsabs.harvard.edu/abs/1989CeMec..45..305N}
{``Numerical Representation of Planetary Ephemerides''}, Celestial Mechanics
and Dynamical Astronomy, Vol. 45, p.305, 1989.

\bibitem[Urban \& Seidelmann 2013]{expl} S.E.~Urban and P.K.~Seidelmann, 
{\it Explanatory Supplement to the Astronomical Almanac}, 3rd edition, 
University Science Books, Mill Valley, California (2013).

\bibitem[Vondr\'ak et al 2011]{VCW} J.~Vondr\'ak, N.~Capitaine, and P.~Wallace, 
\href{http://adsabs.harvard.edu/abs/2011A%26A...534A..22V}
{``New precession expressions, valid for long time intervals''}, 
Astron.\ Astrophys., 534, A22 (2011).

\end{thebibliography}

\end{CJK}
\end{document}
